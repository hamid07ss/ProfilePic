<?php/** * Created by PhpStorm. * User: M.Azadi <mohammad.azadi@yahoo.com> * Date: 3/13/2017 * Time: 1:00 PM */include( '../tel.php' );include( 'Image.php' );$bot_id   = '311505159:AAGs51-qOndfsR2USkEWHoeP1GFjkY2zUfc';$telegram = new Telegram( $bot_id );$result  = $telegram->getData();$text    = $result["message"]["text"];$chat_id = $result["message"]["chat"]["id"];$data     = json_decode( file_get_contents( 'data.json' ), JSON_UNESCAPED_UNICODE );if(isset($result["message"]["photo"])){	$photo_path = $telegram->getFile($result["message"]["photo"][2]["file_id"]);	$telegram->downloadFile($photo_path['result']["file_path"], $photo_path['result']["file_path"]);	$data[$chat_id]['pic'] = 'http://78.47.129.34/test/' . $photo_path['result']["file_path"];	$data[$chat_id]['pic-size'] = $result["message"]["photo"][2];	$content = array(		'chat_id'      => $chat_id,		'text' => 'تعداد سطرهای مورد نظر را وارد کنید.'	);	$telegram->sendMessage( $content );	$data[$chat_id]['step'] = 'row';}else if($data[$chat_id]['step'] == 'row'){	$photo = ImageLines($data[$chat_id]['pic'], intval( $text ), false, $data[$chat_id]['pic-size']['width'], $data[$chat_id]['pic-size']['height']);	$data[$chat_id]['cols-pic'] = $photo;	$data[$chat_id]['row-count'] = intval( $text );	$content = array( 'chat_id' => $chat_id, 'photo' => $photo['image'] );	$telegram->sendPhoto( $content );	$content = array(		'chat_id'      => $chat_id,		'text' => 'تعداد ستون های مورد نظر را وارد کنید.'	);	$telegram->sendMessage( $content );	$data[$chat_id]['step'] = 'col';}else if($data[$chat_id]['step'] == 'col'){	$data[$chat_id]['step'] = 'select row';	$photo = ImageLines($data[$chat_id]['cols-pic']['image'], false, intval( $text ), $data[$chat_id]['pic-size']['width'], $data[$chat_id]['pic-size']['height']);	$data[$chat_id]['cols-pic'] = $photo;	$data[$chat_id]['col-count'] = intval( $text );	$option = [];	for ($i = 0;$i < $data[$chat_id]['row-count'];$i++){		if($i < 4){			$option[0][] = $telegram->buildKeyboardButton( 'سطر ' . ($i + 1) );		}else{			$option[1][] = $telegram->buildKeyboardButton( 'سطر ' . ($i + 1) );		}	}	$kbBTN  = $telegram->buildKeyBoard( $option, true, true );	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'انتخاب کنید'	);	$telegram->sendMessage( $content );	$content = array( 'chat_id' => $chat_id, 'photo' => $photo['image'] );	$telegram->sendPhoto( $content );}else if($data[$chat_id]['step'] == 'select row'){	$data[$chat_id]['step'] = 'select col';	preg_match('/\d+/', $text, $matches);	$data[$chat_id]['row'] = $matches[0];	$option = [];	for ($i = 0;$i < $data[$chat_id]['col-count'];$i++){		if($i < 4){			$option[0][] = $telegram->buildKeyboardButton( 'ستون ' . $data[$chat_id]["cols"]['texts'][$i] );		}else{			$option[1][] = $telegram->buildKeyboardButton( 'ستون ' . $data[$chat_id]["cols"]['texts'][$i] );		}	}	$kbBTN  = $telegram->buildKeyBoard( $option, true, true );	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'ستون را انتخاب کنید.  '	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'select col'){	$data[$chat_id]['step'] = 'text';	$data[$chat_id]['col'] = array_search(str_replace('ستون ', '', $text), $data[$chat_id]["cols"]['texts']) + 1;	$kbBTN  = $telegram->buildKeyBoardHide();	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'متن مورد نظر خود را بنویسید.'	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'text'){	$data[$chat_id]['step'] = 'font';	$data[$chat_id]['user-text'] = $text;	$option = [];	$files = glob('../editor/fonts/ttf/*.ttf');	$row_num = 0;	for ($i = 0;$i < count($files);$i++){		if(($i % 3) == 0 && $i > 0){			$row_num++;		}		$file = $files[$i];		$name = str_replace('.ttf', '', basename( $file ));		$option[$row_num][] = $telegram->buildKeyboardButton( $name );	}	$kbBTN  = $telegram->buildKeyBoard( $option, true, true );	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'فونت مورد نظر خود را انتخاب کنید.'	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'font'){	$data[$chat_id]['step'] = 'color';	$data[$chat_id]['font'] = '../editor/fonts/ttf/'. $text .'.ttf';	$kbBTN  = $telegram->buildKeyBoardHide();	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'سایز متن خود را وارد کنید.'	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'color'){	$data[$chat_id]['step'] = 'final';	$data[$chat_id]['size'] = $text;	$kbBTN  = $telegram->buildKeyBoardHide();	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'رنگ مورد نظر خود را وارد کنید.'	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'final'){	$data[$chat_id]['step'] = false;	$row = $data[$chat_id]['row'];	$col = $data[$chat_id]['col'];	$font = $data[$chat_id]['font'];	$fontSize = intval( $data[ $chat_id ]['size'] );	$photo =		GenerateImage($data[$chat_id]['pic'],			intval( $row ), intval( $col ),			$data[$chat_id]['user-text'],			$font,			$fontSize,			[				"row" => $data[$chat_id]['row-count'],				"col" => $data[$chat_id]['col-count']			],			intval($data[$chat_id]['pic-size']['width']),			intval($data[$chat_id]['pic-size']['height'])			);	$data[$chat_id]['f_photo'] = $photo;	$option = [];	$option[0][] = $telegram->buildKeyboardButton( 'accept' );	$option[0][] = $telegram->buildKeyboardButton( 'send to channel' );	$kbBTN  = $telegram->buildKeyBoard($option, true, true);	$content = array(		'chat_id'      => $chat_id,		'reply_markup' => $kbBTN,		'text' => 'انجام شد.'	);	$telegram->sendMessage( $content );	$content = array( 'chat_id' => $chat_id, 'photo' => $photo );	$telegram->sendPhoto( $content );}else if($text == 'accept'){	$data[$chat_id]['step'] = 'get id';	$content = array(		'chat_id'      => $chat_id,		'text' => 'لطفا آیدی عکس را برای ثبت وارد کنید'	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'get id'){	if(isset( $data[ $text ] )){		$content = array( 'chat_id' => $chat_id, 'photo' => $data[$text]['image'] );		$telegram->sendPhoto( $content );		$content = array(			'chat_id'      => $chat_id,			'text' => 'این آیدی با عکس بالا قبلا ثبت شده است...آیدی دیگری وارد کنید.'		);		$telegram->sendMessage( $content );	}else{		file_put_contents( 'final/' . $text . '.jpg', file_get_contents( $data[ $chat_id ]['f_photo'] ));		$data[$chat_id]['step'] = false;		$row = $data[$chat_id]['row'];		$col = $data[$chat_id]['col'];		$font = $data[$chat_id]['font'];		$fontSize = intval( $data[ $chat_id ]['size'] );		$data[$chat_id]['pic'] = 'http://78.47.129.34/test/final/' . $text . '.jpg';		$data[$text] = [			'image' => 'final/' . $text . '.jpg',			'row' => intval( $row ),			'col' => intval( $col ),			'font' => $font,			'fontSize' => $fontSize,			'parts' => [				"row" => $data[$chat_id]['row-count'],				"col" => $data[$chat_id]['col-count']			]		];		$content = array(			'chat_id'      => $chat_id,			'text' => 'ذخیره شد.'		);		$telegram->sendMessage( $content );	}}else if($text == 'send to channel'){	$data[$chat_id]['step'] = 'get caption';	$content = array(		'chat_id'      => $chat_id,		'text' => 'متن زیر عکس را وارد کنید.'	);	$telegram->sendMessage( $content );}else if($data[$chat_id]['step'] == 'get caption'){	sendToChannel($data[$chat_id]['pic'] . '?t=' . strtotime( date( "Y-m-d H:i:s") ), $text);}function sendToChannel($image, $caption){	$chat_id  = '@ProfilePic_free';	$bot_id   = '246405229:AAG3s1km9QMrl3sH5xy3AFsaz9WUssNOV5g';	$telegram = new Telegram( $bot_id );	$content = array(		'chat_id' => $chat_id,		'photo' => $image,		'caption' => $caption	);	$telegram->sendPhoto( $content );}file_put_contents( 'data.json', json_encode( $data, JSON_UNESCAPED_UNICODE ) );